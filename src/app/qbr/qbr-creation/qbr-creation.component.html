<div class="content-body-inner-wrapper">


  <div id="filtersdiv">
    <lib-bd-filters
      (sendFilters)="storeFilters($event)"
      [collapsed]="appStateService.layout.isCollapsed"
      [excludeFilters]="excludeFilters"
    ></lib-bd-filters>
  </div>
  <div class="mb20" style="height: 36px; line-height: 24px;">
    <mat-slide-toggle *ngIf="userService.hasEntitlement('analytics.expenses')" [checked]="filtersService?.includeExpenses" (change)="toggleExpenses()" class="pt10">Include Expenses
    </mat-slide-toggle>
  </div>
  <div>
    <div class="panel-wrapper mt20">
      <h3>Create QBR</h3>

      <div>
        <label id="report-options-label" style="font-weight: 700;">Report Type:</label>
        <mat-radio-group aria-labelledby="report-options-label"[(ngModel)]="reportType" name="reportOptions" ngDefaultControl>
          <mat-radio-button [value]="'YoY'" [disabled]="true" style="padding-right: 3em; padding-left: 3em;">Year over Year</mat-radio-button>
          <mat-radio-button [value]="'QoQAdjacent'" [disabled]="firstReport" style="padding-right: 3em;">Quarter over Quarter - Adjacent</mat-radio-button>
          <mat-radio-button [value]="'QoQAnnual'" [disabled]="firstReport">Quarter over Quarter - Annual</mat-radio-button>
        </mat-radio-group>

      </div>

      <div style="padding-top: 1em;" class="row">
        <div class="col-sm-12">
          <p *ngIf="firstReport">Select the start date for this initial YoY Report. The date you select will determine the quarters for {{userService.currentUser.client_info.org.name}},
            you will only be able to use those quarters when creating subsequent QoQ reports. If you select January 1, the quarters will be 1/1 - 3/31, 4/1 - 6/30, 7/1 - 9/30, and 10/1 - 12/31.
            If you select February 1, the quarters will be 2/1 - 4/30, 5/1 - 7/31, 8/1 - 10/31, and 11/1 - 1/31, etc.</p>

            <p>Apply any filtering you want on the dataset by using the filters above. You can view the returned metrics, modify the filters or start date, and click Go to see the updated data.</p>
        </div>

        <div class="col-sm-4">
          <h4>Start Date</h4>
          <form [formGroup]="dateForm">
            <mat-form-field class="dateSelector">
              <input matInput [matDatepicker]="dpStartDate" formControlName="startDate"
                     (keydown.enter)="$event.stopPropagation();$event.preventDefault()">
              <mat-datepicker-toggle matSuffix [for]="dpStartDate"></mat-datepicker-toggle>
              <mat-datepicker #dpStartDate></mat-datepicker>
            </mat-form-field>
            <div class="font-red" *ngIf="dateForm.hasError('notFirstOfMonth')">
              The selected start date must be the first day of a month
            </div>
          </form>
        </div>

        <div class="col-sm-4" *ngIf="dateRangeReady">
          <p>
            <b>Selected Time Period: </b>{{reportStartDate | date:'mediumDate'}} - {{reportEndDate | date:'mediumDate'}}
          </p>

          <p>
            <b>Comparison Time Period: </b>{{comparisonStartDate | date:'mediumDate'}} - {{comparisonEndDate | date:'mediumDate'}}
          </p>
        </div>

        <div class="col-sm-4" *ngIf="reportEndDate !== null">
          <button class="primary-button" (click)="generateMetrics()">Generate Metrics</button>
        </div>


      </div>

      <div *ngIf="dataProcessed">
        <div>
          <h4>Key Metrics</h4>
        </div>
        <div class="font-red" *ngIf="metricsForm.hasError('notEnoughSelected')">
          You must select exactly 6 metrics to include in the report.
        </div>
        <form [formGroup]="metricsForm">
          <table style="width: 60%;">
            <tr>
              <th>Include</th>
              <th>Title</th>
              <th>Report Time Period</th>
              <th>Trend</th>
              <th>Comparison Time Period</th>
            </tr>

            <tr>
              <td>
                <mat-checkbox checked="true" formControlName="partner_hourly_cost"></mat-checkbox>
              </td>
              <td>Avg. Partner Hourly Cost</td>
              <td>${{reportData.avg_partner_rate | number:'1.0-0'}}</td>
              <td>{{reportData.partner_rate_trend | number:'1.1-1'}}%</td>
              <td>${{comparisonData.avg_partner_rate | number:'1.0-0'}}</td>
            </tr>

            <tr>
              <td>
                <mat-checkbox checked="true" formControlName="associate_hourly_cost"></mat-checkbox>
              </td>
              <td>Avg. Associate Hourly Cost</td>
              <td>${{reportData.avg_associate_rate | number:'1.0-0'}}</td>
              <td>{{reportData.assoc_rate_trend | number:'1.1-1'}}%</td>
              <td>${{comparisonData.avg_associate_rate | number:'1.0-0'}}</td>
            </tr>

            <tr>
              <td>
                <mat-checkbox checked="true" formControlName="total_spend"></mat-checkbox>
              </td>
              <td>Change in Overall Spend</td>
              <td *ngIf="reportData.total_spend_diff < 0">(${{reportData.total_spend_diff * -1 | number:'1.0-0'}})</td>
              <td *ngIf="reportData.total_spend_diff === 0">${{reportData.total_spend_diff | number:'1.0-0'}}</td>
              <td *ngIf="reportData.total_spend_diff > 0">${{reportData.total_spend_diff | number:'1.0-0'}}</td>
              <td>{{reportData.total_spend_trend | number:'1.1-1'}}%</td>
              <td>--</td>
            </tr>

            <tr>
              <td>
                <mat-checkbox checked="true" formControlName="partner_hours_percent"></mat-checkbox>
              </td>
              <td>% Partner Hours</td>
              <td>{{reportData.partner_percent_hours_worked | number:'1.1-1'}}%</td>
              <td>{{reportData.partner_hrs_trend | number:'1.1-1'}}%</td>
              <td>{{comparisonData.partner_percent_hours_worked | number:'1.1-1'}}%</td>
            </tr>

            <tr>
              <td>
                <mat-checkbox checked="true" formControlName="associate_hours_percent"></mat-checkbox>
              </td>
              <td>% Associate Hours</td>
              <td>{{reportData.associate_percent_hours_worked | number:'1.1-1'}}%</td>
              <td>{{reportData.assoc_hrs_trend | number:'1.1-1'}}%</td>
              <td>{{comparisonData.associate_percent_hours_worked | number:'1.1-1'}}%</td>
            </tr>

            <tr>
              <td>
                <mat-checkbox checked="true" formControlName="block_billing_percent"></mat-checkbox>
              </td>
              <td>% Block Billed</td>
              <td>{{reportData.percent_block_billed | number:'1.1-1'}}%</td>
              <td>{{reportData.bb_trend | number:'1.1-1'}}%</td>
              <td>{{comparisonData.percent_block_billed | number:'1.1-1'}}%</td>
            </tr>

            <tr>
              <td>
                <mat-checkbox checked="false" formControlName="blended_rate"></mat-checkbox>
              </td>
              <td>Blended Rate</td>
              <td>${{reportData.avg_blended_rate | number:'1.0-0'}}</td>
              <td>{{reportData.blended_rate_trend | number:'1.1-1'}}%</td>
              <td>${{comparisonData.avg_blended_rate | number:'1.0-0'}}</td>
            </tr>

            <tr>
              <td>
                <mat-checkbox checked="false" formControlName="bodhala_price_index"></mat-checkbox>
              </td>
              <td>Bodhala Price Index</td>
              <td>${{reportData.bodhala_price_index | number:'1.0-0'}}</td>
              <td>{{reportData.bpi_trend | number:'1.1-1'}}%</td>
              <td>${{comparisonData.bodhala_price_index | number:'1.0-0'}}</td>
            </tr>

          </table>
        </form>


      </div>

      <div *ngIf="dataProcessed">
        <table style="width: 60%;">
          <tr>
            <th>Title</th>
            <th>Metric</th>
            <th>Trend</th>
          </tr>

          <tr>
            <td>Total Spend</td>
            <td *ngIf="reportData.total_spend.total < 0">(${{reportData.total_spend.total * -1 | number:'1.0-0'}})</td>
            <td *ngIf="reportData.total_spend.total === 0">${{reportData.total_spend.total | number:'1.0-0'}}</td>
            <td *ngIf="reportData.total_spend.total > 0">${{reportData.total_spend.total | number:'1.0-0'}}</td>
            <td>{{reportData.total_spend_trend | number:'1.1-1'}}%</td>
            <td></td>
          </tr>

          <tr>
            <td>Top PA 1</td>
            <td>{{topPA.practice_area}}</td>
            <td></td>
          </tr>

          <tr>
            <td>Top PA 2</td>
            <td>{{secondPA.practice_area}}</td>
            <td></td>
          </tr>

          <tr>
            <td>Top PA 1 Spend (Report Timeframe)</td>
            <td>${{topPA.total_billed | number:'1.0-0'}}</td>
            <td></td>
          </tr>

          <tr>
            <td>Top PA 2 Spend (Report Timeframe)</td>
            <td>${{secondPA.total_billed | number:'1.0-0'}}</td>
            <td></td>
          </tr>

          <tr>
            <td>Top PA 1 Top Firms</td>
            <td>1. {{topPATopFirm.firm_name}}<br>
                2. {{topPASecondFirm.firm_name}}</td>
            <td></td>
          </tr>

          <tr *ngIf="secondPATopFirm && secondPASecondFirm">
            <td>Top PA 2 Top Firms</td>
            <td>1. {{secondPATopFirm.firm_name}}<br>
                2. {{secondPASecondFirm.firm_name}}</td>
            <td></td>
          </tr>

          <tr>
            <td></td>
            <td></td>
            <td></td>
          </tr>

          <tr>
            <td></td>
            <td></td>
            <td></td>
          </tr>

          <tr>
            <td></td>
            <td></td>
            <td></td>
          </tr>

          <tr>
            <td></td>
            <td></td>
            <td></td>
          </tr>
        </table>

      </div>

    </div>





  </div>
</div>

